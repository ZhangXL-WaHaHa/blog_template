---
title: 下载保存文件到本地
date: 2021-01-06
categories: 
 - applet
---
## 前言
最近做项目碰到了一种需求：用户下载并保存文件到本地.

刚开始看到这个需求，也没有多在意，因为微信小程序提供了下载文件的接口（downloadFile）和保存文件到本地的接口（saveFile）,但是在真正开发过程中发现了问题:
::: danger
下载完之后找不到文件在哪
:::
## 文件在哪
在测试中发现，下载保存成功之后，我在手机的文件管理找不到对应的下载文件，根本就不知道下载完之后的文件保存在哪。通过查阅资料（微信社区）:

> 真实路径：手机\内部存储\tencent\MicroMsg\wxanewfiles\xxxx\abc.txt
> xxxx：是一个很长的由英文数字组成的文件夹，这个文件夹的命名规则，尚不清楚

好家伙！竟然藏在这。既然出现了问题，就要着手解决。
## 解决办法
在项目，用户下载并把文件保存在本地的根本目的就是可以查阅文件里面的资料。知道这个目的，我们就可以利用小程序的另一个接口——[打开文档](https://developers.weixin.qq.com/miniprogram/dev/api/file/wx.openDocument.html),因此，我们
可以在下载完文件之后直接打开，并设置showMenu这个参数分享出去，便可以实现快速找到：
```js
wx.downloadFile({
    url: file, //仅为示例，并非真实的资源
    success(res) {
     // 获取所下载的文件类型
     const file_type_list = res.tempFilePath.split('.')
     const file_type = file_type_list[file_type_list.length - 1]
     let file_path = res.tempFilePath

     wx.saveFile({
      tempFilePath: file_path,
      filePath: CACHE_PATH + `/${new Date().getTime()}.${file_type}`,
      success(res) {
       wx.hideLoading()
       wx.showToast({
        title: '保存成功',
        icon: 'none'
       })

       // 打开文档
       wx.openDocument({
        filePath: res.savedFilePath,
        fileType: file_type,
        showMenu: true,
        success: function (res) {
         console.log('打开文档成功')
        }
       })
      },
      fail(error) {
       console.log('保存失败', error)
       wx.hideLoading()
       wx.showToast({
        title: '保存失败',
        icon: 'none'
       })
      }
     })
    },
    fail(error) {
     console.log('下载失败', error)
     wx.hideLoading()
     wx.showToast({
      title: '下载失败',
      icon: 'none'
     })

    }
   })
```
然而事情还没有结束，问题又出现了
::: danger
在ios测试中发现打不开下载并保存在本地的文件，但是可以打开下载了，没有保存在本地的文件
:::
![什么鬼问题](./img/public/zhoumei.jpg)

在不断的寻找这个所谓的bug途中，心想，反正ios不提供文件管理器，你能查找？（我放弃了）
```js
// ios不保存文件，直接打开
     if (app.globalData.systemInfo.platform === 'ios') {
      // ios系统没有提供文件搜索，所以直接打开文档分享
      wx.openDocument({
       filePath: file_path,
       fileType: file_type,
       showMenu: true,
       success: function (res) {
        console.log('打开文档成功')
       }
      })
      return
     }
```
## 怎么保存
已经解决了打开文档的问题，现在该解决一下保存问题，毕竟需求是要保存到本地。保存路径已经是只能保存在微信小程序的系统路径中，但是文件夹的名字我们可以自定义啊，曲线解决：
>定义下载好的文件保存到的系统路径：
> wx.env.USER_DATA_PATH是专门获取文件系统中的用户目录路径的常量值。

```js
// 文件保存到本地的路径
const CACHE_PATH = wx.env.USER_DATA_PATH + '/保存文件的文件夹'
```
### 系统路径内是否存在该文件夹
我的思路是：判断系统路径是否存在该文件夹，存在，直接将文件放进去；不存在，创建。这时，要用到小程序的[文件管理器](https://developers.weixin.qq.com/miniprogram/dev/api/file/wx.getFileSystemManager.html)
```js
/**
* 判断系统路径下是否存在该目录
*/
  accessSync() {
   return new Promise((resolve, reject) => {
    const file = wx.getFileSystemManager()
    try {
     file.accessSync(CACHE_PATH)
     resolve()
    } catch (error) {
     resolve(error)
    }
   });
  },
  /**
   * 不存在，创建
   */
  mkdirSync() {
   return new Promise((resolve, reject) => {
    const file = wx.getFileSystemManager()
    try {
     file.mkdirSync(CACHE_PATH, true)
     resolve()
    } catch (error) {
     resolve(error)
    }
   });
```
## 结尾
在多次测试过程中，我还发现安卓端下载完之后不经过保存，直接打开文档分享给好友，分享出来的文件是这样的：

![图片](https://img-blog.csdnimg.cn/20210106173350585.png)